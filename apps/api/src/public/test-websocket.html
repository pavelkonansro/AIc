<!DOCTYPE html>
<html>
<head>
    <title>AIc WebSocket Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .user { background-color: #e3f2fd; text-align: right; }
        .assistant { background-color: #f5f5f5; }
        .system { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        .input-area { margin: 20px 0; }
        .input-area input { width: 70%; padding: 10px; }
        .input-area button { padding: 10px 20px; }
        #sessionInfo { background-color: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>AIc WebSocket Test</h1>

    <div id="sessionInfo">
        <strong>–°–µ—Å—Å–∏—è:</strong> <span id="sessionId">–°–æ–∑–¥–∞–µ—Ç—Å—è...</span><br>
        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="userId">–°–æ–∑–¥–∞–µ—Ç—Å—è...</span>
    </div>

    <div id="status" class="status disconnected">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

    <div id="messages"></div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" disabled>
        <button onclick="sendMessage()" id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <script>
        let socket;
        let sessionId;
        let userId;

        const status = document.getElementById('status');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        async function initializeSession() {
            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
                const timestamp = Date.now();
                const randomId = Math.random().toString(36).substr(2, 9);

                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userResponse = await fetch('/test/create-user', { method: 'POST' });
                const userData = await userResponse.json();
                userId = userData.userId;
                document.getElementById('userId').textContent = `${userData.userId} (${randomId})`;

                // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é —á–∞—Ç–∞
                const sessionResponse = await fetch('/test/create-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId })
                });
                const sessionData = await sessionResponse.json();
                sessionId = sessionData.sessionId;
                document.getElementById('sessionId').textContent = `${sessionData.sessionId} (${randomId})`;

                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
                connectWebSocket();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                addMessage('error', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }

        function connectWebSocket() {
            // –ï—Å–ª–∏ —Å–æ–∫–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ—Ç–∫–ª—é—á–∞–µ–º –µ–≥–æ
            if (socket) {
                socket.disconnect();
                socket = null;
            }

            console.log('üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket...');
            socket = io('http://localhost:3000/chat', {
                forceNew: true // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            });

            socket.on('connect', () => {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                status.className = 'status connected';

                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —Å–µ—Å—Å–∏–∏
                socket.emit('join_session', { sessionId: sessionId });
                addMessage('system', '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å–µ—Å—Å–∏–∏: ' + sessionId);

                messageInput.disabled = false;
                sendBtn.disabled = false;
            });

            socket.on('disconnect', () => {
                console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                status.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                status.className = 'status disconnected';
                messageInput.disabled = true;
                sendBtn.disabled = true;
            });

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            socket.off('message');
            socket.off('typing');
            socket.off('error');

            socket.on('message', (data) => {
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                addMessage(data.role || 'assistant', data.content || '');
            });

            socket.on('typing', (data) => {
                console.log('‚å®Ô∏è –°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∏:', data);
                if (data.isTyping) {
                    addMessage('system', 'AIc –ø–µ—á–∞—Ç–∞–µ—Ç...');
                } else {
                    // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—á–∞—Ç–∏
                    const systemMessages = messages.querySelectorAll('.system');
                    const lastSystem = systemMessages[systemMessages.length - 1];
                    if (lastSystem && lastSystem.textContent.includes('–ø–µ—á–∞—Ç–∞–µ—Ç')) {
                        lastSystem.remove();
                    }
                }
            });

            socket.on('error', (data) => {
                console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', data);
                addMessage('error', '–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            });
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !socket || !sessionId) return;

            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:', text);
            const messageData = {
                sessionId: sessionId,
                text: text
            };

            socket.emit('chat:message', messageData);
            messageInput.value = '';
        }

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<strong>${role}:</strong> ${content}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !messageInput.disabled) {
                sendMessage();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        initializeSession();
    </script>
</body>
</html>