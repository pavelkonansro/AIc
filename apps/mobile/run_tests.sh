#!/bin/bash

# AIc Mobile App - Test Runner Script
# –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Ç–∏–ø—ã —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

echo "üß™ AIc Mobile App - –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤"
echo "======================================="

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é mobile –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd "$(dirname "$0")"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "pubspec.yaml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω pubspec.yaml —Ñ–∞–π–ª"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ apps/mobile"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
flutter pub get

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ–∫-–∫–ª–∞—Å—Å—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤..."
flutter packages pub run build_runner build --delete-conflicting-outputs

# –ó–∞–ø—É—Å–∫–∞–µ–º unit —Ç–µ—Å—Ç—ã
echo ""
echo "üî¨ –ó–∞–ø—É—Å–∫–∞–µ–º unit —Ç–µ—Å—Ç—ã..."
echo "------------------------"
flutter test test/ --coverage

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –Ω–∞ –æ—à–∏–±–∫–∏
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –Ω–∞ –æ—à–∏–±–∫–∏..."
echo "-----------------------------"
flutter analyze

# –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω–æ)
echo ""
echo "üöÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
DEVICES=$(flutter devices --machine | jq -r '.[].id')

if [ -n "$DEVICES" ]; then
    echo "üì± –ù–∞–π–¥–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
    flutter devices
    
    echo ""
    echo "üîó –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã..."
    echo "-----------------------------------"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ –ø–µ—Ä–≤–æ–º –¥–æ—Å—Ç—É–ø–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    FIRST_DEVICE=$(echo "$DEVICES" | head -n 1)
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $FIRST_DEVICE"
    
    flutter test integration_test/app_test.dart -d "$FIRST_DEVICE" || {
        echo "‚ö†Ô∏è  –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
        echo "   –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
    }
else
    echo "‚ö†Ô∏è  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo "   –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
echo ""
echo "üìä –û—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ —Ç–µ—Å—Ç–∞–º–∏:"
echo "----------------------------"
if [ -f "coverage/lcov.info" ]; then
    echo "‚úÖ –§–∞–π–ª –ø–æ–∫—Ä—ã—Ç–∏—è —Å–æ–∑–¥–∞–Ω: coverage/lcov.info"
    
    # –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω lcov, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if command -v lcov >/dev/null 2>&1; then
        echo ""
        lcov --summary coverage/lcov.info
    else
        echo "üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ lcov –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫—Ä—ã—Ç–∏—è:"
        echo "   brew install lcov  # –Ω–∞ macOS"
    fi
else
    echo "‚ö†Ô∏è  –§–∞–π–ª –ø–æ–∫—Ä—ã—Ç–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω"
fi

echo ""
echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "========================="

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É
echo ""
echo "üìã –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞:"
echo "  ‚úÖ Unit —Ç–µ—Å—Ç—ã: –ü—Ä–æ–≤–µ—Ä—è—é—Ç AuthService, AuthController, –Ω–∞–≤–∏–≥–∞—Ü–∏—é"
echo "  ‚úÖ Widget —Ç–µ—Å—Ç—ã: –ü—Ä–æ–≤–µ—Ä—è—é—Ç UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ"
echo "  ‚úÖ Integration —Ç–µ—Å—Ç—ã: –ü—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–ª–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π flow"
echo "  ‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞"
echo ""
echo "üöÄ –î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ç–µ—Å—Ç–æ–≤:"
echo "   flutter test test/services/          # –¢–æ–ª—å–∫–æ —Å–µ—Ä–≤–∏—Å—ã"
echo "   flutter test test/state/             # –¢–æ–ª—å–∫–æ state management"
echo "   flutter test test/features/          # –¢–æ–ª—å–∫–æ UI —Ç–µ—Å—Ç—ã"
echo "   flutter test integration_test/       # –¢–æ–ª—å–∫–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ"
echo ""
echo "üì± –î–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:"
echo "   flutter test integration_test/ -d <device_id>"